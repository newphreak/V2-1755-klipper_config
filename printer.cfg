# This file contains common pin mappings for the Fysetc Spider board.
# To use this config, the firmware should be compiled for the STM32F446.
# When calling "menuconfig", enable "extra low-level configuration setup"
# and select the "12MHz crystal" as clock reference
# For flashing, write the compiled klipper.bin to memory location 0x08000000

## Homing end position				[gcode_macro G32] section
## Z Endstop Switch  offset for Z0		[stepper_z] section
## Probe points							[quad_gantry_level] section
## Min & Max gantry corner postions		[quad_gantry_level] section
## PID tune								[extruder] and [heater_bed] sections
## Fine tune E steps					[extruder] section

[mcu]
##  You need to select 'Communication interface' to USB in 'make menuconfig'
##  when you compile Klipper for Spider
##	Obtain definition by "ls -l /dev/serial/by-id/" then unplug to verify
##--------------------------------------------------------------------
#serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_350030000750305538333620-if00
##	If you want to use the Raspberry uart0 to communicate with Spider, 
##  you need to select 'Communication interface' to 'Serial (on USART1 PA10/PA9)' 
##  in 'make menuconfig' when you compile klipper and set the serial as below
##--------------------------------------------------------------------
serial: /dev/ttyAMA0
restart_method: command

[mcu rpi]
serial: /tmp/klipper_host_mcu

[adxl345]
cs_pin: rpi:None

[resonance_tester]
accel_chip: adxl345
probe_points:
    150,150,20

[include fluidd.cfg]

[temperature_sensor raspberry_pi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[printer]
kinematics: corexy
max_velocity: 300  
max_accel: 4000
max_accel_to_decel: 2000
max_z_velocity: 20
max_z_accel: 350
square_corner_velocity: 5.0

[input_shaper]
shaper_freq_x: 46.6
shaper_type_x: mzv
shaper_freq_y: 62.6
shaper_type_y: 3hump_ei

[frame_expansion_compensation]
temp_coeff: 0.0145
#   The temperature coefficient of expansion, in mm/K. For example, a
#   temp_coeff of 0.01 mm/K will move the Z axis downwards by 0.01 mm for every
#   Kelvin/degree celcius that the frame temperature increases. Defaults to 0.0,
#   no offset.
#smooth_time:
#   Smoothing window applied to the temp_sensor, in seconds. Can reduce motor
#   noise from excessive small corrections in response to sensor noise. The
#   default is 2.0 seconds.
#max_comp_z:
#   Disables compensation above this Z height [mm]. The last computed correction
#   will remain applied until the toolhead moves below the specified Z position
#   again. The default is 0.0mm (always on).
#max_z_offset: 0.2
#   Maximum absolute compensation that can be applied to the Z axis [mm]. The
#   default is 99999999.0mm (unlimited).
temp_sensor: temperature_sensor frame
#   Temperature sensor to use for frame temp measurement. Use full config
#   section name without quoutes. E.g. temperature_sensor frame
#sensor_type: ntc_50k
#sensor_pin: PC2
#min_temp: 0
#max_temp: 100
z_stepper: stepper_z

#####################################################################
#   Extruder
#####################################################################

##	In E0-MOT Position
[extruder]
step_pin: PD5
dir_pin: !PD6
enable_pin: !PD4
max_extrude_only_distance: 200
##	Update value below when you perform extruder calibration
##	If you ask for 100mm of filament, but in reality it is 98mm:
##	rotation_distance = <previous_rotation_distance> * <actual_extrude_distance> / 100
##  22.6789511 is a good starting point
#rotation_distance: 22.6789511	#Bondtech 5mm Drive Gears
#rotation_distance: 21.700
#Jasrags distance:
#rotation_distance: 21.39731821
#e3v2 distance(calculated one for tl bmg v2)
rotation_distance: 22.598
gear_ratio: 50:17				#BMG Gear Ratio
microsteps: 16
full_steps_per_rotation: 200
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin: PB15
sensor_type: ATC Semitec 104GT-2
sensor_pin: PC0
min_temp: 10
max_temp: 290
max_power: 1.0
min_extrude_temp: 195
[tmc2209 extruder]
uart_pin: PD7
interpolate: false
run_current: 0.5
hold_current: 0.4
sense_resistor: 0.110
stealthchop_threshold: 0

#####################################################################
#      X/Y Stepper Settings
#####################################################################

[stepper_x]
##	Connected to X-MOT (B Motor)
step_pin: PE11
dir_pin: !PE10
enable_pin: !PE9
rotation_distance: 40
microsteps: 16
full_steps_per_rotation:200
endstop_pin: ^PB14
position_min: 0
position_endstop: 299
position_max: 299
homing_speed: 50   #Max 100
homing_retract_dist: 5
homing_positive_dir: true
[tmc2209 stepper_x]
uart_pin: PE7
interpolate: True
run_current: 0.9
hold_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_y]
##	Connected to Y-MOT (A Motor)
step_pin: PD8
dir_pin: !PB12
enable_pin: !PD9
rotation_distance: 40
microsteps: 16
full_steps_per_rotation:200
endstop_pin: ^PB13
position_min: 0
position_endstop: 300
position_max: 300
homing_speed: 50  #Max 100
homing_retract_dist: 5
homing_positive_dir: true
[tmc2209 stepper_y]
uart_pin: PE15
interpolate: True
run_current: 0.9
hold_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

#####################################################################
#   Z Stepper Settings
#####################################################################

## In E1-MOT Position
## Z0 Stepper - Front Left
[stepper_z]
step_pin: PE6
dir_pin: !PC13
enable_pin: !PE5
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16
endstop_pin: ^PA0
position_max: 290
position_min: -5
homing_speed: 20
second_homing_speed: 3
homing_retract_dist: 3
[tmc2209 stepper_z]
uart_pin: PC14
uart_address: 0
interpolate: True
run_current: 0.9
hold_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 100

##	In E2-MOT Position
##	Z1 Stepper - Rear Left
[stepper_z1]
step_pin: PE2
dir_pin: PE4
enable_pin: !PE3
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16
[tmc2209 stepper_z1]
uart_pin: PC15
interpolate: True
run_current: 0.9
hold_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 100

##	In E3-MOT Position
##	Z2 Stepper - Rear Right
[stepper_z2]
step_pin: PD12
dir_pin: !PC4
enable_pin: !PE8
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16
[tmc2209 stepper_z2]
uart_pin: PA15
interpolate: true
run_current: 0.9
hold_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 100

##	In E4-MOT Position
##	Z3 Stepper - Front Right
[stepper_z3]
step_pin: PE1
dir_pin: PE0
enable_pin: !PC5
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16
[tmc2209 stepper_z3]
uart_pin: PD11
interpolate: true
run_current: 0.9
hold_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 100

#####################################################################
#   Retraction
#####################################################################
#[firmware_retraction]
#retract_length: 0.5
#retract_speed: 30
#unretract_extra_length: 0
#unretract_speed: 30

#####################################################################
#   Bed Heater
#####################################################################
[heater_bed]
##	SSR Pin - In BED OUT position
heater_pin: PB4
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin: PC3
max_power: 0.6
min_temp: 10
max_temp: 124

#####################################################################
#	Probe
#####################################################################

[probe]
pin: ^PA3
x_offset: 0
y_offset: 25.0
speed: 10.0
samples: 3
samples_result: median
sample_retract_dist: 3.0
samples_tolerance: 0.006
samples_tolerance_retries: 3

#####################################################################
#	Bed Mesh
#####################################################################

[bed_mesh]
speed: 300
horizontal_move_z: 10
mesh_min: 40, 40
mesh_max: 260,260
fade_start: 0.6
fade_end: 10.0
probe_count: 5,5
algorithm: bicubic
relative_reference_index: 12

#####################################################################
#	Fan Control
#####################################################################

[heater_fan hotend_fan]
##  Hotend Fan - In E2 OUT Positon
pin: PB3
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0

[fan]
##	Print Cooling Fan - FAN1 Connector
pin: PB1
max_power: 1.0
kick_start_time: 0.5
off_below: 0.10

[heater_fan skirt_fan]
##	Skirt fans - FAN0 Connector
pin: PB0
max_power: 1.0
shutdown_speed: 0.0
kick_start_time: 0.3
heater: heater_bed
heater_temp: 20
fan_speed: 1.0

[fan_generic exhaust_fan]
##  Exhaust fan - In E1 OUT Positon
pin: PC8
max_power: 1.0
kick_start_time: 0.3
#off_below: 0.20
shutdown_speed: 0.0

[fan_generic nevermore]
## Nevermore fan - In FAN2
pin: PB2
max_power: 1.0
kick_start_time: 0.3
shutdown_speed: 0.0
#####################################################################
#	LED Control
#####################################################################

[neopixel caselight]
##  Chamber Lighting - In 5V-RGB Position
pin: PD3
chain_count: 10
initial_RED: 0.56
initial_GREEN: 0.0
initial_BLUE: 0.74

#####################################################################
#	Thermistors
#####################################################################

[thermistor chamber_temp]
temperature1: 0
resistance1: 355975
temperature2: 50
resistance2: 33195
temperature3: 100
resistance3: 5384
[temperature_sensor chamber]
sensor_type: chamber_temp
sensor_pin: PC1
min_temp: 0
max_temp: 70
gcode_id: C

[thermistor frame_temp]
temperature1: 20
resistance1: 125245
temperature2: 50
resistance2: 35900
temperature3: 80
resistance3: 12933
[temperature_sensor frame]
sensor_type: frame_temp
sensor_pin: PC2
min_temp: 0
max_temp: 70
gcode_id: frame

[thermistor extruder]
#ATC Semitec 104GT-2 104NT-4-R025H42G
temperature1: 25.0
resistance1: 100000
temperature2: 160.0
resistance2: 1074
temperature3: 260.0
resistance3: 125
#####################################################################
#	Homing and Gantry Adjustment Routines
#####################################################################

[idle_timeout]
timeout: 1800

[safe_z_home]
home_xy_position:205,300
speed:50
z_hop:10
   
[quad_gantry_level]
gantry_corners:
	-60,-10
	360,370
points:
	50,25
	50,225
	250,225
	250,25
speed: 150
horizontal_move_z: 10
retries: 5
retry_tolerance: 0.0075
max_adjust: 10

#####################################################################
#	Displays
#####################################################################

[display]
#	mini12864 LCD Display
lcd_type: uc1701
cs_pin: PC11
a0_pin: PD2
rst_pin: PC10
encoder_pins: ^PC6,^PC7
click_pin: ^!PA8
contrast: 63
spi_software_mosi_pin: PA7
spi_software_miso_pin: PA6
spi_software_sclk_pin: PA5

[neopixel fysetc_mini12864]
#	To control Neopixel RGB in mini12864 display
pin: PC12
chain_count: 3
chain_count: 60
initial_RED: 0.56
initial_GREEN: 0.0
initial_BLUE: 0.74
color_order: RGB

#	Set RGB values on boot up for each Neopixel. 
#	Index 1 = display, Index 2 and 3 = Knob
[delayed_gcode setdisplayneopixel]
initial_duration: 1
gcode:
        SET_LED LED=fysetc_mini12864 RED=1 GREEN=1 BLUE=1 INDEX=1 TRANSMIT=0
        SET_LED LED=fysetc_mini12864 RED=0.56 GREEN=0 BLUE=0.74 INDEX=2 TRANSMIT=0
        SET_LED LED=fysetc_mini12864 RED=0.56 GREEN=0 BLUE=0.74 INDEX=3


#####################################################################
#	Macros
#####################################################################
[include configs/tones.cfg]

[gcode_shell_command backup_cfg]
command: sh /home/pi/klipper_config/autocommit.sh
timeout: 30.0
verbose: True

[gcode_macro BACKUP_CFG]
gcode:
  RUN_SHELL_COMMAND CMD=backup_cfg

[gcode_macro G32]
gcode:
    M117 E.T. Phone Home
    G28
    M117 QGL Squeek Crack
    QUAD_GANTRY_LEVEL
    M117 Homing.....
    G28

#########NEEDED IN SLICER FOR TEMPERATURES TO WORK###########################################################################################################################
## START_PRINT BED_TEMPERATURE=[first_layer_bed_temperature] EXTRUDER_TEMPERATURE=[first_layer_temperature] CHAMBER=[chamber_temperature] FILAMENT_TYPE={filament_type[0]} ##
#############################################################################################################################################################################
[gcode_macro START_PRINT]
default_parameter_BED_TEMPERATURE: 60
default_parameter_EXTRUDER_TEMPERATURE: 200
default_parameter_CHAMBER: 42
gcode:
    G28
    G90                                                                         ;Absolute positioning
    G1 X150 Y150 Z20 F12000
    {% if FILAMENT_TYPE == "ABS" or FILAMENT_TYPE == "ASA" %}
      SET_FAN_SPEED FAN=exhaust_fan SPEED=0.10
      SET_FAN_SPEED FAN=nevermore SPEED=0.60
    {% endif %}
    M106 S255
      M117 ~bed~ warming: {params.BED_TEMPERATURE}~degrees~
  M190 S{params.BED_TEMPERATURE}                                                            ; Set bed to final temp and wait

  {% set chamber = printer['temperature_sensor chamber'] %}
  {% if params.BED_TEMPERATURE|int > 70 and chamber.temperature < params.CHAMBER|int %}     ; Heat soak if needed
    M117 Soaking: {CHAMBER}~degrees~
    M109 S150                                                                   ; Set hotend to 150 and wait for temp
    TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={CHAMBER}      ; Wait for chamber temp
    M106 S0                                                                     ; Turn on Part Cooling Fan off
    M117 Steaming HOT!
  {% endif %}
    SONG_SIMPLE_DONE
    G32
    M117 Calibrating Mesh
    BED_MESH_CALIBRATE
    BED_MESH_PROFILE LOAD=default
    G1 X50 Y5 Z10 F15000                                                        ;Move to front left corner and wait for nozzle temperature
    M117 ~extruder~ heating up.
    M109 S{EXTRUDER_TEMPERATURE}                                                ;Set real nozzle temperature1
    M117 Reloading..
    G1 E7 F900
    G92 E0.0
    M117 Printer goes Brr

[gcode_macro PRIME_LINE]
gcode:
    M117 Nozzle go squirt
    G1 X30 F1000                                                               ;Purge all da shits
    G1 Z0.4 X40 F720
    G1 X110.0 E8 F900
    G1 X170 E10 F700
    G92 E0.0
    M117 Printer goes Brr

[gcode_macro END_PRINT]
gcode:
    M117 WOHO, FINITO
    G91                                                                         ;Relative positioning
    G1 E-8 Z0.2 F1500                                                           ;Retract and raise Z
    G1 X5 Y5 F15000                                                             ;Wipe out
    G1 Z10                                                                      ;Raise Z more
    G90                                                                         ;Absolute positioning
    G92 E0                                                                      ;Reset extruder
    M106 S0                                                                     ;Turn-off fan
    M104 S0                                                                     ;Turn-off hotend
    M140 S0                                                                     ;Turn-off bed
    SONG_STARWARS_IMP
    G28 X0 Y0                                                                   ;Home X and Y
    BED_MESH_CLEAR
    {% if FILAMENT_TYPE == "ABS" or FILAMENT_TYPE == "ASA" %}
    FILTER_CHAMBER TIME=10
    {% endif %}
    UPDATE_DELAYED_GCODE ID=shutoff_timer DURATION=60

[delayed_gcode shutoff_timer]
gcode:
  M84 X Y Z E
  M117

[gcode_macro FILTER_CHAMBER]
default_parameter_TIME: 10 #filter time (minutes)
gcode:
    M117 Filtering air
    SET_FAN_SPEED FAN=nevermore SPEED=0.65
    SET_FAN_SPEED FAN=exhaust_fan SPEED=0.25
    {% set wait = 60000 * TIME|float %} 
    G4 P{wait|int}
    SET_FAN_SPEED FAN=nevermore SPEED=0
    SET_FAN_SPEED FAN=exhaust_fan SPEED=0
    M117

[gcode_macro M600]
default_parameter_X: 20
default_parameter_Y: 20
default_parameter_Z: 40
gcode:
    SAVE_GCODE_STATE NAME=M600                                                  ;Save state
    PAUSE                                                                       ;Pause print
        G91                                                                     ;Relative positioning
    G1 Z20 F900                                                                 ;Raise Z away from print
    G90                                                                         ;Absolute positioning
    G1 X{X} Y{Y} F5000                                                          ;Move to purge bucket
    G1 Z{Z} F5000                                                               ;Move to purge bucket
    UNLOAD_FILAMENT                                                             ;Unload the spool so you can change color
    SONG_SIMPLE_DONE
        RESTORE_GCODE_STATE NAME=M600                                           ;Restore state

[gcode_macro UNLOAD_FILAMENT]
gcode:
    G91                                                                         ;Relative positioning
    G1 E5 F300                                                                 ;Extrude a little
    G1 E10 F150                                                                 ;extrude some more
    G1 E-20 F2400                                                               ;Yank it out as fast as it'll go
    G1 E-100 F1600                                                              ;Throw it out the length of the bowden tube
    G90                                                                         ;Absolute positioning

[gcode_macro LOAD_FILAMENT]
gcode:
    SAVE_GCODE_STATE NAME=LOAD                                                  ;Save state
    G91                                                                         ;Relative positioning
        G1 E150 F300                                                            ;Printer go OMNOMNOMNOM
    G90                                                                         ;Absolute positioning
    RESTORE_GCODE_STATE NAME=LOAD                               ;Restore state
    SET_IDLE_TIMEOUT TIMEOUT=7200                               ;Timeout

[gcode_macro PURGE_NOZZLE]
gcode:
    G91                                                                         ;Relative positioning
    G1 E45.0 F250                                                               ;Extrude 45mm of filament
    G90                                                                         ;Absolute positionin

# For example SPEEDTEST I=10
# Compare the GET_POSITION output before and after, see if you skipped steps. IIRC you want the "mcu" line to show within 16 before and after (a full step)
[gcode_macro SPEEDTEST]
gcode:
  #Parameters
  {% set i = params.I|default(1)|int %}
  
  SAVE_GCODE_STATE NAME=SPEEDTEST
  G28 X Y
  GET_POSITION
  G90                              ; absolute positioning
  {% for iteration in range(i|int) %}
    G1 X0 Y0     F27000
    G1 X290 Y290 F27000
    G1 X0 Y0     F27000
    G1 X290 Y290 F27000

    G1 X0 Y290 F36000

    G1 X290 Y0 F27000
    G1 X0 Y290 F27000
    G1 X290 Y0 F27000
    G1 X0 Y290 F27000

    G1 X0 Y0 F36000
    G1 X290 Y0 F36000
    G1 X290 Y290 F36000
    G1 X0 Y290 F36000
    G1 X0 Y0 F36000
  {% endfor %}
  G28 X Y
  GET_POSITION
  RESTORE_GCODE_STATE NAME=SPEEDTEST

[gcode_arcs]
resolution: 0.05

[respond]
default_type: echo

[pause_resume]
recover_velocity: 50.
    
## 	Thermistor Types
##   "EPCOS 100K B57560G104F"
##   "ATC Semitec 104GT-2"
##   "NTC 100K beta 3950"
##   "Honeywell 100K 135-104LAG-J01"
##   "NTC 100K MGB18-104F39050L32" (Keenovo Heater Pad)
##   "AD595"
##   "PT100 INA826"

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 39.578
#*# pid_ki = 1.589
#*# pid_kd = 246.373
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 21.687
#*# pid_ki = 1.095
#*# pid_kd = 107.350
#*#
#*# [stepper_z]
#*# position_endstop = -1.465
#*#
#*# [probe]
#*# z_offset = 0.575
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.037500, 0.017500, 0.017500, 0.045000, 0.062500
#*# 	0.022500, 0.002500, 0.000000, -0.002500, 0.012500
#*# 	0.027500, 0.005000, 0.000000, -0.012500, 0.007500
#*# 	0.017500, -0.005000, -0.007500, -0.012500, 0.002500
#*# 	0.045000, 0.017500, 0.012500, 0.010000, 0.035000
#*# tension = 0.2
#*# min_x = 40.0
#*# algo = bicubic
#*# y_count = 5
#*# mesh_y_pps = 2
#*# min_y = 40.0
#*# x_count = 5
#*# max_y = 260.0
#*# mesh_x_pps = 2
#*# max_x = 260.0
